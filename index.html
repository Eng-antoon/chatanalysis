<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WhatsApp Chat Analyzer</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: #fafafa;
      color: #333;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
    }
    .section {
      background: #fff;
      padding: 20px;
      margin-bottom: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
    }
    input[type="number"],
    input[type="text"],
    input[type="file"],
    button {
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
      margin-right: 10px;
    }
    button,
    .load-more {
      background: #4caf50;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    button:hover,
    .load-more:hover {
      background: #45a049;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 15px;
    }
    th, td {
      border: 1px solid #eee;
      padding: 8px;
      text-align: left;
    }
    th {
      background: #f0f0f0;
    }
    .chart .bar {
      display: flex;
      align-items: center;
      margin-bottom: 6px;
    }
    .chart .bar span {
      display: inline-block;
      width: 100px;
      font-size: 0.9rem;
    }
    .chart .fill {
      flex: 1;
      height: 18px;
      background: #4caf50;
      border-radius: 4px;
    }
    details summary {
      cursor: pointer;
      font-weight: 600;
      margin-bottom: 10px;
    }
    #results h2 {
      margin-top: 0;
    }
    .interest {
      display: flex;
      justify-content: space-around;
      margin-top: 15px;
    }
    .interest div {
      flex: 1;
      margin: 0 8px;
      padding: 12px;
      border-radius: 6px;
      text-align: center;
      font-size: 0.95rem;
    }
    .interest .interested {
      background: #e8f5e9;
      color: #2e7d32;
    }
    .interest .not-interested {
      background: #ffebee;
      color: #c62828;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>WhatsApp Chat Analyzer</h1>

    <div class="section">
      <label for="threshold">Quick Reply Threshold (minutes):</label>
      <input type="number" id="threshold" value="5" min="1" />
    </div>

    <div class="section">
      <label for="fileInput">Upload WhatsApp Chat Backup (.txt):</label>
      <input type="file" id="fileInput" accept=".txt" />
    </div>

    <div class="section">
      <label for="searchInput">Search word or sentence (fuzzy):</label>
      <input type="text" id="searchInput" placeholder="Type word or full phrase..." />
      <button id="searchBtn">Search</button>
    </div>

    <div id="results"></div>
  </div>

  <script>
    const excludedWords = ['el','w','ana','enty','bs','kda','eh','media','omitted','msh'];
    const LOAD_BATCH = 20;
    const FUZZY_RATIO = 0.3;  // threshold for fuzzy match

    let _msgs = [], _users = [];

    document.getElementById('fileInput').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => analyzeChat(reader.result);
      reader.readAsText(file, 'UTF-8');
    });

    document.getElementById('searchBtn').addEventListener('click', () => {
      const q = document.getElementById('searchInput').value.trim().toLowerCase();
      if (!q) return alert('Please enter a word or sentence to search for.');
      displaySearch(q);
    });

    // Levenshtein distance
    function levenshtein(a, b) {
      const m = [], n = b.length, o = a.length;
      for (let i = 0; i <= n; i++) m[i] = [i];
      for (let j = 0; j <= o; j++) m[0][j] = j;
      for (let i = 1; i <= n; i++) {
        for (let j = 1; j <= o; j++) {
          m[i][j] = b[i-1] === a[j-1]
            ? m[i-1][j-1]
            : Math.min(m[i-1][j-1]+1, m[i][j-1]+1, m[i-1][j]+1);
        }
      }
      return m[n][o];
    }

    function parseMessages(text) {
      return text.split(/\r?\n/).reduce((msgs, line) => {
        const re = /^(\d{1,2})\/(\d{1,2})\/(\d{2}),\s*(\d{1,2}):(\d{2})\s*([AP]M)\s*-\s*([^:]+):\s*(.*)$/;
        const m = line.match(re);
        if (m) {
          let [_, mo,d,yr,h,min,ampm,sender,content] = m, hour = +h;
          if (ampm==='PM'&&hour<12) hour+=12;
          if (ampm==='AM'&&hour===12) hour=0;
          const date = new Date(2000+ +yr, +mo-1, +d, hour, +min);
          msgs.push({ timestamp: date, sender: sender.trim(), content: content.trim() });
        } else if (msgs.length) {
          msgs[msgs.length-1].content += ' ' + line.trim();
        }
        return msgs;
      }, []);
    }

    function analyzeWords(msgs, users) {
      const raw = {}; users.forEach(u=>raw[u]={});
      msgs.forEach(({sender,content})=>{
        content.toLowerCase()
               .replace(/[^؀-ۿ\w\s]|_/g,' ')
               .split(/\s+/)
               .filter(w=>w&&!excludedWords.includes(w))
               .forEach(w=> raw[sender][w] = (raw[sender][w]||0)+1);
      });
      const stats = {};
      users.forEach(u=>{
        const filtered = Object.fromEntries(
          Object.entries(raw[u]).filter(([k,c])=>c>=10)
        );
        const cons = consolidateCounts(filtered);
        stats[u] = Object.entries(cons).sort((a,b)=>b[1]-a[1]);
      });
      return stats;
    }

    function analyzeSentences(msgs, users) {
      const raw = {}; users.forEach(u=>raw[u]={});
      msgs.forEach(({sender,content})=>{
        content.split(/[\.\!?]\s*/)
               .map(s=>s.trim())
               .filter(s=>s)
               .forEach(s=> raw[sender][s] = (raw[sender][s]||0)+1);
      });
      const stats = {};
      users.forEach(u=>{
        const filtered = Object.fromEntries(
          Object.entries(raw[u]).filter(([k,c])=>c>=10)
        );
        const cons = consolidateCounts(filtered, 0.1);
        stats[u] = Object.entries(cons).sort((a,b)=>b[1]-a[1]);
      });
      return stats;
    }

    function analyzeResponseTimes(msgs) {
      const diffs = [], diffsByUser = {};
      _users.forEach(u=> diffsByUser[u]=[]);
      let prev = null;
      msgs.forEach(msg=>{
        if (prev && msg.sender!==prev.sender) {
          const mins = (msg.timestamp - prev.timestamp)/60000;
          if (mins<=1440) {
            diffs.push(mins);
            diffsByUser[msg.sender].push(mins);
          }
        }
        prev = msg;
      });
      const threshold = parseFloat(document.getElementById('threshold').value)||5;
      const quick = diffs.filter(d=>d<=threshold);
      const activeSec = diffs.reduce((a,b)=>a+b,0)*60;
      const avg = diffs.length ? diffs.reduce((a,b)=>a+b,0)/diffs.length : 0;
      return { activeDuration: activeSec, avgReply: avg, quickCount: quick.length,
               quickTime: quick.reduce((a,b)=>a+b,0), diffsByUser };
    }

    function analyzeConversationStarts(msgs) {
      const counts = {}; let total = 0;
      msgs.forEach((m,i)=>{
        if (i===0 || (m.timestamp - msgs[i-1].timestamp)/60000 >= 240) {
          counts[m.sender] = (counts[m.sender]||0)+1;
          total++;
        }
      });
      const perc = {};
      _users.forEach(u=> perc[u] = (counts[u]||0)/total*100);
      return { counts, perc };
    }

    function analyzeInterest(msgs, startStats, respStats) {
      const threshold = parseFloat(document.getElementById('threshold').value)||5;
      const interest = {};
      _users.forEach(u=>{
        const diffs = respStats.diffsByUser[u]||[];
        const responses = diffs.length;
        const quick = diffs.filter(d=>d<=threshold).length;
        const responseRate = responses ? quick/responses : 0;
        const startRate = startStats.perc[u]/100;
        const score = responseRate*0.6 + startRate*0.4;
        interest[u] = { responseRate, startRate, score, interested: score>=0.5 };
      });
      return interest;
    }

    function consolidateCounts(counts, thresholdRatio=0.2) {
      const result = {};
      Object.keys(counts).forEach(key=>{
        let merged = false;
        for (const rep in result) {
          const dist = levenshtein(key, rep);
          const ratio = dist/Math.max(key.length, rep.length);
          if (ratio <= thresholdRatio) {
            result[rep] += counts[key];
            merged = true;
            break;
          }
        }
        if (!merged) result[key] = counts[key];
      });
      return result;
    }

    function formatDuration(sec) {
      const d = Math.floor(sec/86400),
            h = Math.floor((sec%86400)/3600),
            m = Math.floor((sec%3600)/60),
            s = Math.floor(sec%60);
      return `${d}d ${h}h ${m}m ${s}s`;
    }

    function makeLoadMore(table) {
      const rows = Array.from(table.querySelectorAll('tr')).slice(1);
      if (rows.length <= LOAD_BATCH) return;
      rows.forEach((r,i)=>{ if (i>=LOAD_BATCH) r.style.display='none'; });
      const btn = document.createElement('button');
      btn.className = 'load-more';
      btn.innerText = 'Load more...';
      btn.addEventListener('click', ()=>{ rows.forEach(r=>r.style.display=''); btn.remove(); });
      table.parentNode.insertBefore(btn, table.nextSibling);
    }

    function analyzeChat(text) {
      const msgs = parseMessages(text);
      if (msgs.length < 2) {
        alert('No valid chat messages found or too few messages to analyze.');
        return;
      }
      const users = [...new Set(msgs.map(m=>m.sender))];
      _msgs = msgs; _users = users;

      const wordStats = analyzeWords(msgs, users);
      const sentenceStats = analyzeSentences(msgs, users);
      const respStats = analyzeResponseTimes(msgs);
      const startStats = analyzeConversationStarts(msgs);

      displayResults(users, wordStats, sentenceStats, respStats, startStats);
    }

    function displayResults(users, wordStats, sentenceStats, respStats, startStats) {
      const div = document.getElementById('results');
      div.innerHTML = '';

      // Chat Metrics
      const info = document.createElement('details');
      info.open = true;
      info.className = 'section';
      info.innerHTML = `
        <summary>Chat Metrics</summary>
        <p>Active chat time (excl. >24h gaps): <strong>${formatDuration(respStats.activeDuration)}</strong></p>
        <p>Avg reply time: <strong>${respStats.avgReply.toFixed(2)} min</strong></p>
        <p>Quick replies (≤ threshold): <strong>${respStats.quickCount}</strong>, total <strong>${respStats.quickTime.toFixed(2)} min</strong></p>
      `;
      div.appendChild(info);

      // Conversation Starters
      const startD = document.createElement('details');
      startD.open = true;
      startD.className = 'section';
      startD.innerHTML = `<summary>Conversation Starters (%)</summary>`;
      const stTable = document.createElement('table');
      stTable.innerHTML = '<tr><th>User</th><th>Starts</th><th>%</th></tr>';
      users.forEach(u=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${u}</td><td>${startStats.counts[u]||0}</td><td>${startStats.perc[u].toFixed(2)}%</td>`;
        stTable.appendChild(tr);
      });
      startD.appendChild(stTable);
      const chart = document.createElement('div'); chart.className='chart';
      users.forEach(u=>{
        const bar = document.createElement('div'); bar.className='bar';
        bar.innerHTML = `<span>${u}</span><div class="fill" style="width:${startStats.perc[u]}%"></div>`;
        chart.appendChild(bar);
      });
      startD.appendChild(chart);
      div.appendChild(startD);

      // Interest Analysis
      const interestStats = analyzeInterest(_msgs, startStats, respStats);
      const interestDiv = document.createElement('div');
      interestDiv.className = 'section';
      const ih = document.createElement('h2');
      ih.innerText = 'Interest Analysis';
      interestDiv.appendChild(ih);
      const interestContainer = document.createElement('div');
      interestContainer.className = 'interest';
      users.forEach(u=>{
        const st = interestStats[u];
        const box = document.createElement('div');
        box.className = st.interested ? 'interested' : 'not-interested';
        box.innerHTML = `
          <strong>${u}</strong><br>
          Response rate: ${(st.responseRate*100).toFixed(1)}%<br>
          Start rate: ${(st.startRate*100).toFixed(1)}%<br>
          Score: ${(st.score*100).toFixed(1)}%<br>
          ${st.interested ? 'Likely interested' : 'Less interested'}
        `;
        interestContainer.appendChild(box);
      });
      interestDiv.appendChild(interestContainer);
      div.appendChild(interestDiv);

      // Per-user Word/Sentence Lists
      users.forEach(u=>{
        const ud = document.createElement('details');
        ud.className = 'section';
        const sum = document.createElement('summary');
        sum.innerText = `User: ${u}`;
        ud.appendChild(sum);

        // Words
        const wSec = document.createElement('details');
        wSec.innerHTML = `<summary>Words & Counts (count ≥ 10)</summary>`;
        const wTbl = document.createElement('table');
        wTbl.innerHTML = '<tr><th>Word</th><th>Count</th></tr>';
        wordStats[u].forEach(([w,c])=>{
          const r = document.createElement('tr');
          r.innerHTML = `<td>${w}</td><td>${c}</td>`;
          wTbl.appendChild(r);
        });
        wSec.appendChild(wTbl);
        makeLoadMore(wTbl);
        ud.appendChild(wSec);

        // Sentences
        const sSec = document.createElement('details');
        sSec.innerHTML = `<summary>Sentences & Counts (count ≥ 10)</summary>`;
        const sTbl = document.createElement('table');
        sTbl.innerHTML = '<tr><th>Sentence</th><th>Count</th></tr>';
        sentenceStats[u].forEach(([s,c])=>{
          const r = document.createElement('tr');
          r.innerHTML = `<td>${s}</td><td>${c}</td>`;
          sTbl.appendChild(r);
        });
        sSec.appendChild(sTbl);
        makeLoadMore(sTbl);
        ud.appendChild(sSec);

        div.appendChild(ud);
      });
    }

    // Fuzzy word-count within one message
    function fuzzyCount(content, query) {
      const words = content
        .toLowerCase()
        .replace(/[^؀-ۿ\w\s]|_/g,' ')
        .split(/\s+/)
        .filter(Boolean);
      let count = 0;
      for (const w of words) {
        const dist = levenshtein(w, query);
        const ratio = dist / Math.max(w.length, query.length);
        if (ratio <= FUZZY_RATIO) count++;
      }
      return count;
    }
    // Exact substring occurrences (for multi-word)
    function substringCount(content, query) {
      let idx = 0, count = 0, txt = content.toLowerCase();
      while (true) {
        const i = txt.indexOf(query, idx);
        if (i >= 0) { count++; idx = i + query.length; }
        else break;
      }
      return count;
    }

    function displaySearch(query) {
      const div = document.getElementById('results');
      const old = document.getElementById('searchResults');
      if (old) old.remove();

      const sr = document.createElement('div');
      sr.id = 'searchResults';
      sr.className = 'section';
      const header = document.createElement('h2');
      header.innerText = `Search results for “${query}”`;
      sr.appendChild(header);

      const counts = {}, series = {};
      _users.forEach(u => { counts[u] = 0; series[u] = {}; });

      _msgs.forEach(({ sender, content, timestamp }) => {
        const day = timestamp.toISOString().slice(0,10);
        const cnt = query.includes(' ')
          ? substringCount(content, query)
          : fuzzyCount(content, query);
        if (cnt > 0) {
          counts[sender] += cnt;
          series[sender][day] = (series[sender][day]||0) + cnt;
        }
      });

      // summary table
      const tbl = document.createElement('table');
      tbl.innerHTML = '<tr><th>User</th><th>Count</th></tr>';
      _users.forEach(u => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${u}</td><td>${counts[u]}</td>`;
        tbl.appendChild(tr);
      });
      sr.appendChild(tbl);

      // timeline charts
      _users.forEach(u => {
        const grp = document.createElement('details');
        grp.open = true;
        grp.innerHTML = `<summary>Timeline for ${u}</summary>`;
        const dates = Object.keys(series[u]).sort();
        if (!dates.length) {
          const p = document.createElement('p');
          p.innerText = 'No occurrences found';
          grp.appendChild(p);
        } else {
          const max = Math.max(...dates.map(d=>series[u][d]));
          const chartDiv = document.createElement('div');
          chartDiv.className = 'chart';
          dates.forEach(d => {
            const bar = document.createElement('div');
            bar.className = 'bar';
            bar.innerHTML = `<span>${d}</span>
                             <div class="fill" style="width:${(series[u][d]/max*100).toFixed(1)}%"></div>`;
            chartDiv.appendChild(bar);
          });
          grp.appendChild(chartDiv);
        }
        sr.appendChild(grp);
      });

      div.insertBefore(sr, div.firstChild);
    }
  </script>
</body>
</html>
